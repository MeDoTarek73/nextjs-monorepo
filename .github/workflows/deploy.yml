name: Deploy to k3s

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        run: |
          # Convert repository name to lowercase
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "Building image: ghcr.io/$REPO_NAME:latest"
          echo "Repository: ${{ github.repository }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Actor: ${{ github.actor }}"

          docker buildx build \
            --platform linux/amd64 \
            --file apps/nextjs-app/Dockerfile \
            --tag ghcr.io/$REPO_NAME:latest \
            --tag ghcr.io/$REPO_NAME:${{ github.sha }} \
            --push .

          echo "âœ… Image pushed successfully"

      - name: Make package public (optional)
        run: |
          # Convert repository name to lowercase for package name
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          PACKAGE_NAME=$(basename $REPO_NAME)
          echo "Repository: ${{ github.repository }}"
          echo "Package name: $PACKAGE_NAME"

          echo "Waiting for package to be created..."
          sleep 15

          echo "Attempting to make package public..."
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.REGISTRY_PASSWORD }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/packages/container/$PACKAGE_NAME/visibility" \
            -d '{"visibility":"public"}' || echo "Failed to make package public - this is normal for first run"

          echo "ðŸ“¦ Package should be visible at: https://github.com/${{ github.repository }}/packages"

      - name: Verify package in GitHub
        run: |
          echo "ðŸ” Package should be visible at:"
          echo "ðŸ“¦ https://github.com/${{ github.repository }}/packages"
          echo ""
          echo "ðŸ“‹ If package is not visible:"
          echo "1. Wait 5-10 minutes for GitHub to process"
          echo "2. Check if package is private and needs manual public setting"
          echo "3. Verify Container Registry is enabled for the repository"
          echo ""
          echo "ðŸ”§ If package appears under user account instead of repository:"
          echo "1. Check if repository has Container Registry enabled"
          echo "2. Verify repository settings > Actions > Workflow permissions"
          echo "3. Ensure the package is created under the repository, not user account"

      - name: Deploy to k3s
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > kubeconfig
          export KUBECONFIG=kubeconfig
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout status deployment/nextjs-app
